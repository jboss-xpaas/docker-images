XPaaS JBoss UberFire cluster controller Docker image
====================================================

This project builds a [docker](http://docker.io/) container for running the cluster controller for UberFire based web applications.      

This image provides a container including:     
* Apache Zookeeper IO v3.4.6        
* Apache Helix v0.6.3       

This image is used as a cluster controller for both BPMS/BRMS v6.1       

Table of contents
------------------
* **[Control scripts](#control-scripts)**
* **[Building the docker container](#building-the-docker-container)**
* **[Running the container](#running-the-container)**
* **[Accessing the container](#accessing-the-container)**
* **[Logging](#logging)**
* **[Stopping the container](#stopping-the-container)**
* **[Experimenting](#experimenting)**

Control scripts
---------------

There are three control scripts for running this image:        
    
* <code>build.sh</code> Builds the XPaaS JBoss Uberfire cluster controller docker image    
* <code>start.sh</code> Starts a new XPaaS JBoss Uberfire cluster controller docker container based on this image    
* <code>stop.sh</code>  Stops the runned XPaaS JBoss Uberfire cluster controller docker container    

Building the docker container
-----------------------------

Once you have [installed docker](https://www.docker.io/gettingstarted/#h_installation) you should be able to create the containers via the following:

If you are on OS X then see [How to use Docker on OS X](DockerOnOSX.md).

First, clone the repository:      
    
    git clone git@github.com:jboss-xpaas/docker-images.git
    cd docker-images/other/uberfire-cluster-controller/6.1/xpaas-uberfire-cluster-controller

Build the container:       

    ./build.sh

Running the container
---------------------

To run a new container:
    
    ./start.sh [-c <container_name>]
    Example: ./start.sh -c xpaas_uf_cluster_controller

Or you can try it out via docker command directly:

    docker run -P -d [--name <container_name>] redhat/xpaas-uberfire-cluster-controller:6.1

These commands will start Zookeeper server.      

**Environment variables**         

You can set additional environment variables when running the container for configuring the Zookeeper server:       

- <code>ZOOKEEPER_CLIENT_PORT</code> - The client port for the Zookeeper server. If not set, defaults to <code>2181</code>          
- <code>CLUSTER_NAME</code> - The name of the cluster registered. If not set, defaults to <code>zk-cluster</code>          
- <code>VFS_REPO</code> - The name of Helix resource to add in cluster with name <code>CLUSTER_NAME</code>. If not set, defaults to <code>vfs-repo</code>          

Accessing the container
-----------------------

You can access the container using <code>nsenter</code>.        

To access your latest running container type:      

    sudo nsenter -t $(docker inspect --format '{{ .State.Pid }}' $(docker ps -lq)) -m -u -i -n -p -w

To access a given <code>container_id</code> type:

    sudo nsenter -t $(docker inspect --format '{{ .State.Pid }}' <container_id> ) -m -u -i -n -p -w

Logging
-------

You can see all logs generated by the <code>standalone</code> binary running:

    docker logs [-f] <container_id>
    
You can attach the container by running:

    docker attach <container_id>

You can find the Helix controller logs for the registered cluster inside the container at path:
    
    /tmp/controller.log

Stopping the container
----------------------

To stop the previous container run using <code>start.sh</code> script just type:

    ./stop.sh

Experimenting
-------------
To spin up a shell in one of the containers try:

    docker run -P -i -t redhat/xpaas-uberfire-cluster-controller /bin/bash

You can then noodle around the container and run stuff & look at files etc.

In order to run all container services provided by this image, you have to run the following command:

    /opt/jboss/scripts/zookeeper/startup.sh
